<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vacation Awaits Utalii ¬∑ Payment receipts</title>
    <style>
        * { box-sizing: border-box; margin: 0; font-family: 'Segoe UI', Roboto, system-ui, sans-serif; }
        body { background: #f0f4f8; display: flex; justify-content: center; padding: 20px; min-height: 100vh; }
        #app { max-width: 1300px; width: 100%; background: white; border-radius: 32px; box-shadow: 0 20px 40px -10px rgba(0,20,40,0.2); overflow: hidden; padding: 28px; }
        h1, h2, h3 { color: #0b2b44; font-weight: 500; }
        button, .btn-like { background: #0b2b44; color: white; border: none; padding: 10px 20px; border-radius: 40px; font-weight: 500; cursor: pointer; transition: all 0.1s; border: 1px solid transparent; }
        button.secondary { background: white; color: #0b2b44; border: 1px solid #b0c8da; }
        button.danger { background: #b12a2a; }
        button.small { padding: 6px 12px; font-size: 0.85rem; }
        input, select, textarea { padding: 10px 16px; border-radius: 30px; border: 1px solid #cbd6e3; font-size: 0.95rem; width: 100%; margin: 6px 0 12px; background: #f9fcff; }
        label { font-weight: 500; color: #1e3a5f; margin-left: 8px; }
        .card { background: #f9fcff; border-radius: 24px; padding: 24px; margin: 24px 0; border: 1px solid #e2eaf2; }
        .flex { display: flex; gap: 20px; flex-wrap: wrap; align-items: center; }
        .grid-2 { display: grid; grid-template-columns: 1fr 2fr; gap: 28px; }
        .receipt-table { width: 100%; border-collapse: collapse; background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.02); }
        .receipt-table th { background: #dae6f2; color: #0b2b44; font-weight: 600; padding: 14px 8px; }
        .receipt-table td { padding: 12px 8px; border-bottom: 1px solid #eaeef4; }
        .badge-role { background: #0b2b44; color: white; border-radius: 40px; padding: 4px 14px; font-size: 0.8rem; display: inline-block; margin-left: 10px; }
        .error { color: #b12a2a; font-size: 0.9rem; margin: 8px 0; }
        .success { color: #1f7b4d; }
        .totals-card { background: #0b2b44; color: white; border-radius: 28px; padding: 24px; font-size: 2rem; font-weight: 600; }
        .signature-line { margin-top: 24px; border-top: 1px dashed #5f7d9c; padding-top: 20px; display: flex; justify-content: space-between; }
        .print-only { display: none; }
        @media print {
            .no-print, button, .action-bar { display: none !important; }
            .print-only { display: block; }
            body { background: white; }
            .receipt-print { border: 1px solid #ccc; padding: 20px; max-width: 400px; margin: auto; }
        }
        .password-section { background: #eaf1fa; border-radius: 28px; padding: 20px; margin-top: 24px; }
        .clickable { cursor: pointer; }
        .navbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; background: #ffffffdd; padding: 8px 16px; border-radius: 60px; border: 1px solid #d4e0ec; }
        .logo { font-weight: 600; font-size: 1.4rem; color: #0f3b5e; }
    </style>
</head>
<body>
<div id="app"></div>

<script>
    (function() {
        // ---------- storage initialization ----------
        const STORAGE_USERS = 'vaca_users';
        const STORAGE_RECEIPTS = 'vaca_receipts';

        // default users: admin (with security question) and accountant (empty password, will be set by admin)
        const defaultUsers = {
            admin: {
                password: 'admin123',
                role: 'admin',
                securityQuestion: 'Your favorite pet?',
                securityAnswer: 'cat'          // simple for demo
            },
            accountant: {
                password: 'acc123',            // initial, but admin can change
                role: 'accountant'
                // accountant has no security question (cannot reset own password)
            }
        };

        if (!localStorage.getItem(STORAGE_USERS)) {
            localStorage.setItem(STORAGE_USERS, JSON.stringify(defaultUsers));
        }

        if (!localStorage.getItem(STORAGE_RECEIPTS)) {
            // demo receipts
            const demo = [
                { id: 'r1', studentName: 'Ali Mwinyi', amount: 45000, date: '2025-03-10', paymentFor: 'Tuition', accountantSignature: '', studentSignature: '' },
                { id: 'r2', studentName: 'Zahara Juma', amount: 23000, date: '2025-03-15', paymentFor: 'Hostel fee', accountantSignature: '', studentSignature: '' },
            ];
            localStorage.setItem(STORAGE_RECEIPTS, JSON.stringify(demo));
        }

        // ---------- global state ----------
        let currentUser = null;            // { username, role }
        let editingReceiptId = null;       // for form

        // helper to load receipts
        function getReceipts() {
            return JSON.parse(localStorage.getItem(STORAGE_RECEIPTS)) || [];
        }

        function saveReceipts(receipts) {
            localStorage.setItem(STORAGE_RECEIPTS, JSON.stringify(receipts));
        }

        function getUsers() {
            return JSON.parse(localStorage.getItem(STORAGE_USERS)) || {};
        }

        function saveUsers(users) {
            localStorage.setItem(STORAGE_USERS, JSON.stringify(users));
        }

        // ---------- render function (simple router) ----------
        function render() {
            const app = document.getElementById('app');
            if (!currentUser) {
                app.innerHTML = renderLogin();
                attachLoginHandler();
                attachForgotHandler();
            } else {
                if (currentUser.role === 'admin') {
                    app.innerHTML = renderAdminDashboard();
                } else {
                    app.innerHTML = renderAccountantDashboard();
                }
                attachLogoutHandler();
                attachDashboardActions();
            }
        }

        // ---------- login view ----------
        function renderLogin() {
            return `
                <div style="max-width: 500px; margin: 40px auto;">
                    <div style="text-align: center; margin-bottom: 40px;">
                        <h1>‚úàÔ∏è Vacation Awaits Utalii</h1>
                        <p style="color: #346392;">receipt system ¬∑ admin / accountant</p>
                    </div>
                    <div class="card">
                        <h2>Login</h2>
                        <div id="loginError" class="error"></div>
                        <label>Username</label>
                        <input type="text" id="loginUsername" placeholder="admin or accountant" value="admin">
                        <label>Password</label>
                        <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="admin123">
                        <button id="loginBtn" style="width: 100%;">Sign in</button>
                        <div style="margin-top: 20px; text-align: right;">
                            <button class="secondary small" id="forgotPasswordBtn">Forgot password? (admin only)</button>
                        </div>
                        <hr style="margin: 24px 0; border-color: #dbe5f0;">
                        <div style="font-size:0.9rem; color:#2e4e7a;">Demo: admin/admin123  |  accountant/acc123</div>
                    </div>
                </div>
            `;
        }

        function attachLoginHandler() {
            document.getElementById('loginBtn')?.addEventListener('click', () => {
                const username = document.getElementById('loginUsername').value.trim();
                const pwd = document.getElementById('loginPassword').value.trim();
                const users = getUsers();
                const user = users[username];
                if (user && user.password === pwd) {
                    currentUser = { username, role: user.role };
                    render();
                } else {
                    document.getElementById('loginError').innerText = 'Invalid credentials';
                }
            });
        }

        // forgot password for admin only (simple security question)
        function attachForgotHandler() {
            document.getElementById('forgotPasswordBtn')?.addEventListener('click', () => {
                const username = prompt('Enter admin username:');
                if (!username) return;
                const users = getUsers();
                if (username !== 'admin' || !users.admin) {
                    alert('Only admin can reset password via this demo.');
                    return;
                }
                const adminData = users.admin;
                const answer = prompt(`Security question: ${adminData.securityQuestion}`);
                if (answer && answer.toLowerCase() === adminData.securityAnswer.toLowerCase()) {
                    const newPw = prompt('Answer correct. Enter new password (at least 4 chars):');
                    if (newPw && newPw.length >= 4) {
                        users.admin.password = newPw;
                        saveUsers(users);
                        alert('Password updated. Please login with new password.');
                    } else alert('Invalid password');
                } else {
                    alert('Wrong answer.');
                }
            });
        }

        // ---------- admin dashboard ----------
        function renderAdminDashboard() {
            const receipts = getReceipts();
            const totalPayments = receipts.reduce((sum, r) => sum + Number(r.amount), 0);
            const receiptsRows = receipts.map(r => `
                <tr>
                    <td>${r.studentName}</td>
                    <td>${r.date}</td>
                    <td>${r.paymentFor}</td>
                    <td>KSh ${Number(r.amount).toLocaleString()}</td>
                    <td>
                        <button class="small" data-id="${r.id}" data-action="editReceipt">‚úé edit</button>
                        <button class="small danger" data-id="${r.id}" data-action="deleteReceipt">üóë</button>
                        <button class="small secondary" data-id="${r.id}" data-action="printReceipt">üñ®Ô∏è print</button>
                    </td>
                </tr>
            `).join('');

            return `
                <div>
                    <div class="navbar">
                        <span class="logo">‚úàÔ∏è Utalii College ¬∑ admin</span>
                        <div>
                            <span class="badge-role">${currentUser.username} (${currentUser.role})</span>
                            <button id="logoutBtn" class="small secondary">Logout</button>
                        </div>
                    </div>

                    <div class="grid-2">
                        <div>
                            <div class="totals-card">
                                üí∞ TOTAL PAYMENTS<br>
                                <span style="font-size: 3rem;">KSh ${totalPayments.toLocaleString()}</span>
                            </div>

                            <div class="password-section">
                                <h3>üîê Admin only</h3>
                                <label>Change accountant password</label>
                                <input type="password" id="newAccPassword" placeholder="new password for accountant">
                                <button id="changeAccPwdBtn" class="small">Update accountant password</button>

                                <label style="margin-top: 20px;">Change your own password (admin)</label>
                                <input type="password" id="oldAdminPwd" placeholder="current password">
                                <input type="password" id="newAdminPwd" placeholder="new password">
                                <button id="changeOwnPwdBtn" class="small">Change admin password</button>
                                <div id="adminPwdMsg" class="success"></div>
                            </div>
                        </div>

                        <div>
                            <div class="card" style="margin-top:0;">
                                <h2>‚ûï Add / edit receipt</h2>
                                <div id="receiptForm">
                                    <label>Student name</label>
                                    <input type="text" id="studentName" value="" placeholder="e.g. John Kamau">
                                    <label>Amount (KSh)</label>
                                    <input type="number" id="amount" value="" min="0">
                                    <label>Payment for</label>
                                    <input type="text" id="paymentFor" value="" placeholder="Tuition, hostel, etc">
                                    <label>Date</label>
                                    <input type="date" id="date" value="${new Date().toISOString().slice(0,10)}">
                                    <div class="flex">
                                        <button id="saveReceiptBtn">üíæ Save receipt</button>
                                        <button class="secondary" id="cancelEditBtn" style="display:none;">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="flex" style="justify-content:space-between;">
                            <h2>üìã Receipt records</h2>
                            <div>
                                <button id="exportExcelBtn" class="secondary">üìé Export Excel (CSV)</button>
                            </div>
                        </div>
                        <table class="receipt-table">
                            <thead><tr><th>Student</th><th>Date</th><th>For</th><th>Amount</th><th>Actions</th></tr></thead>
                            <tbody>
                                ${receiptsRows || '<tr><td colspan="5" style="text-align:center;">No receipts yet</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // ---------- accountant dashboard (no totals, no password changes) ----------
        function renderAccountantDashboard() {
            const receipts = getReceipts();
            const receiptsRows = receipts.map(r => `
                <tr>
                    <td>${r.studentName}</td>
                    <td>${r.date}</td>
                    <td>${r.paymentFor}</td>
                    <td>KSh ${Number(r.amount).toLocaleString()}</td>
                    <td>
                        <button class="small" data-id="${r.id}" data-action="editReceipt">‚úé edit</button>
                        <button class="small danger" data-id="${r.id}" data-action="deleteReceipt">üóë</button>
                        <button class="small secondary" data-id="${r.id}" data-action="printReceipt">üñ®Ô∏è print</button>
                    </td>
                </tr>
            `).join('');

            return `
                <div>
                    <div class="navbar">
                        <span class="logo">‚úàÔ∏è Utalii College ¬∑ accountant</span>
                        <div>
                            <span class="badge-role">${currentUser.username} (${currentUser.role})</span>
                            <button id="logoutBtn" class="small secondary">Logout</button>
                        </div>
                    </div>

                    <div class="card" style="margin-top:0;">
                        <h2>‚ûï Add / edit receipt</h2>
                        <div id="receiptForm">
                            <label>Student name</label>
                            <input type="text" id="studentName" value="" placeholder="e.g. John Kamau">
                            <label>Amount (KSh)</label>
                            <input type="number" id="amount" value="" min="0">
                            <label>Payment for</label>
                            <input type="text" id="paymentFor" value="" placeholder="Tuition, hostel, etc">
                            <label>Date</label>
                            <input type="date" id="date" value="${new Date().toISOString().slice(0,10)}">
                            <div class="flex">
                                <button id="saveReceiptBtn">üíæ Save receipt</button>
                                <button class="secondary" id="cancelEditBtn" style="display:none;">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="flex" style="justify-content:space-between;">
                            <h2>üìã Receipt records</h2>
                            <div>
                                <button id="exportExcelBtn" class="secondary">üìé Export Excel (CSV)</button>
                            </div>
                        </div>
                        <table class="receipt-table">
                            <thead><tr><th>Student</th><th>Date</th><th>For</th><th>Amount</th><th>Actions</th></tr></thead>
                            <tbody>
                                ${receiptsRows || '<tr><td colspan="5" style="text-align:center;">No receipts yet</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // ---------- common event binding ----------
        function attachLogoutHandler() {
            document.getElementById('logoutBtn')?.addEventListener('click', () => {
                currentUser = null;
                editingReceiptId = null;
                render();
            });
        }

        function attachDashboardActions() {
            // save receipt (create/update)
            document.getElementById('saveReceiptBtn')?.addEventListener('click', () => {
                const student = document.getElementById('studentName').value.trim();
                const amount = document.getElementById('amount').value;
                const paymentFor = document.getElementById('paymentFor').value.trim();
                const date = document.getElementById('date').value;
                if (!student || !amount || !paymentFor || !date) {
                    alert('Please fill all fields');
                    return;
                }
                const receipts = getReceipts();
                if (editingReceiptId) {
                    // edit
                    const index = receipts.findIndex(r => r.id === editingReceiptId);
                    if (index !== -1) {
                        receipts[index] = { ...receipts[index], studentName: student, amount, paymentFor, date };
                    }
                    editingReceiptId = null;
                    document.getElementById('cancelEditBtn').style.display = 'none';
                } else {
                    // new
                    const newId = 'rec_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
                    receipts.push({ id: newId, studentName: student, amount, paymentFor, date, accountantSignature: '', studentSignature: '' });
                }
                saveReceipts(receipts);
                render(); // refresh
            });

            // cancel edit
            document.getElementById('cancelEditBtn')?.addEventListener('click', () => {
                editingReceiptId = null;
                document.getElementById('studentName').value = '';
                document.getElementById('amount').value = '';
                document.getElementById('paymentFor').value = '';
                document.getElementById('date').value = new Date().toISOString().slice(0,10);
                document.getElementById('cancelEditBtn').style.display = 'none';
            });

            // edit buttons (delegation because table rows are re-rendered)
            document.querySelectorAll('[data-action="editReceipt"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    const receipts = getReceipts();
                    const rec = receipts.find(r => r.id === id);
                    if (rec) {
                        document.getElementById('studentName').value = rec.studentName;
                        document.getElementById('amount').value = rec.amount;
                        document.getElementById('paymentFor').value = rec.paymentFor;
                        document.getElementById('date').value = rec.date;
                        editingReceiptId = id;
                        document.getElementById('cancelEditBtn').style.display = 'inline-block';
                    }
                });
            });

            // delete
            document.querySelectorAll('[data-action="deleteReceipt"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if (!confirm('Delete receipt?')) return;
                    const id = e.target.dataset.id;
                    let receipts = getReceipts();
                    receipts = receipts.filter(r => r.id !== id);
                    saveReceipts(receipts);
                    render();
                });
            });

            // print receipt (opens print dialog with styled receipt)
            document.querySelectorAll('[data-action="printReceipt"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    const receipts = getReceipts();
                    const rec = receipts.find(r => r.id === id);
                    if (!rec) return;
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <html><head><title>Receipt ${rec.studentName}</title>
                        <style>
                            body { font-family: sans-serif; padding: 40px; max-width: 500px; margin:0 auto; }
                            .receipt { border: 2px solid #0b2b44; padding: 32px; border-radius: 24px; background: #fefefe; }
                            h2 { color: #0b2b44; }
                            .signature-line { margin-top: 40px; display: flex; justify-content: space-between; }
                            .line { border-bottom: 1px solid black; width: 200px; margin-top: 30px; }
                            .print-date { color: #444; margin: 20px 0; }
                        </style>
                        </head><body>
                        <div class="receipt">
                            <h2>‚úàÔ∏è Vacation Awaits Utalii College</h2>
                            <p><strong>Student:</strong> ${rec.studentName}</p>
                            <p><strong>Amount paid:</strong> KSh ${Number(rec.amount).toLocaleString()}</p>
                            <p><strong>Payment for:</strong> ${rec.paymentFor}</p>
                            <p><strong>Date:</strong> ${rec.date}</p>
                            <div class="signature-line">
                                <div>Accountant signature: _________________________</div>
                                <div>Student signature: ___________________________</div>
                            </div>
                            <p class="print-date">Printed on: ${new Date().toLocaleString()}</p>
                        </div>
                        <script>window.onload=function(){window.print();window.onafterprint=function(){window.close()}}<\/script>
                        </body></html>
                    `);
                    printWindow.document.close();
                });
            });

            // export excel (csv)
            document.getElementById('exportExcelBtn')?.addEventListener('click', () => {
                const receipts = getReceipts();
                if (!receipts.length) { alert('No data to export'); return; }
                const headers = ['Student', 'Date', 'Payment For', 'Amount (KSh)'];
                const rows = receipts.map(r => [r.studentName, r.date, r.paymentFor, r.amount]);
                const csvContent = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' }); // BOM for chinese/excel
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `receipts_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
            });

            // ---------- admin specific actions ----------
            if (currentUser?.role === 'admin') {
                // change accountant password
                document.getElementById('changeAccPwdBtn')?.addEventListener('click', () => {
                    const newPwd = document.getElementById('newAccPassword').value.trim();
                    if (!newPwd) { alert('Enter new password'); return; }
                    const users = getUsers();
                    if (users.accountant) {
                        users.accountant.password = newPwd;
                        saveUsers(users);
                        document.getElementById('newAccPassword').value = '';
                        alert('Accountant password updated.');
                    } else alert('Accountant user missing');
                });

                // change own admin password
                document.getElementById('changeOwnPwdBtn')?.addEventListener('click', () => {
                    const old = document.getElementById('oldAdminPwd').value.trim();
                    const newPwd = document.getElementById('newAdminPwd').value.trim();
                    const users = getUsers();
                    if (users.admin.password !== old) {
                        document.getElementById('adminPwdMsg').innerText = 'Old password incorrect';
                        return;
                    }
                    if (newPwd.length < 4) { alert('Min 4 chars'); return; }
                    users.admin.password = newPwd;
                    saveUsers(users);
                    document.getElementById('adminPwdMsg').innerText = '‚úÖ Password changed';
                    document.getElementById('oldAdminPwd').value = '';
                    document.getElementById('newAdminPwd').value = '';
                });
            }
        }

        // initial render
        render();
    })();
</script>
</body>
</html>
